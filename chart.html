<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Highcharts Candlestick Chart</title>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <style>
        /* Ensure the container fills the entire viewport */
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars */
        }
        #container {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <script>
        console.log('chart.html loaded and listening for messages.');

        let currentChart = null;
        let originalData = []; // To store the original OHLC data
        let indicators = {}; // To keep track of added indicators

        /**
         * Initializes the Highcharts candlestick chart.
         * @param {Array} data - The OHLC data array.
         */
        function initializeChart(data) {
            if (currentChart) {
                currentChart.destroy();
            }

            originalData = data; // Store original data

            currentChart = Highcharts.stockChart('container', {
                chart: {
                    backgroundColor: '#0D0F17', // Dark background color
                    style: {
                        color: '#d2d4dc' // White text
                    },
                    panning: {
                        enabled: true,
                        type: 'x'
                    },
                    panKey: 'shift', // Optional: requires holding shift to pan
                    zoomType: 'x',
                    events: {
                        load: function () {
                            const chart = this;
                            // Make chart responsive
                            window.addEventListener('resize', function () {
                                chart.reflow();
                            });
                        }
                    }
                },
                navigator: {
                    enabled: false // Disable navigator
                },
                scrollbar: {
                    enabled: false // Disable scrollbar
                },
                rangeSelector: {
                    enabled: false // Remove clickable zoom options
                },
                title: {
                    text: null // Remove chart title
                },
                xAxis: {
                    type: 'datetime',
                    gridLineColor: '#333333', // Faint grid color for x-axis
                    gridLineWidth: 0.5, // Thin grid lines
                    labels: {
                        style: {
                            color: '#ffffff'
                        }
                    },
                    title: {
                        text: null // Remove xAxis title
                    }
                },
                yAxis: {
                    gridLineColor: '#333333', // Faint grid color for y-axis
                    gridLineWidth: 0.5, // Thin grid lines
                    labels: {
                        style: {
                            color: '#ffffff'
                        }
                    },
                    title: {
                        text: null // Remove yAxis title
                    }
                },
                tooltip: {
                    backgroundColor: '#333333',
                    style: {
                        color: '#ffffff'
                    },
                    shared: true,
                    crosshairs: true,
                    valueDecimals: 2,
                    headerFormat: '<b>{series.name}</b><br/>',
                    pointFormat: 'Date: {point.x:%Y-%m-%d}<br/>Open: {point.open}<br/>High: {point.high}<br/>Low: {point.low}<br/>Close: {point.close}'
                },
                plotOptions: {
                    candlestick: {
                        lineColor: null, // No line around the candles
                        borderColor: null, // Remove border color
                        borderWidth: 0, // Set border width to 0
                        upColor: '#039981', // Green for upward candles
                        color: '#f23645' // Red for downward candles
                    },
                    series: {
                        animation: true, // Enable smooth animations
                        turboThreshold: 0
                    }
                },
                series: [{
                    type: 'candlestick',
                    name: 'Price',
                    data: data,
                    id: 'main-series',
                    tooltip: {
                        valueDecimals: 2
                    }
                }]
            });

            // Set the initial visible range to the most recent 3 days
            const recentDays = 3; // Display the last 3 days initially
            const latestTimestamp = data[data.length - 1][0];
            const daysInMillis = 24 * 60 * 60 * 1000;
            const initialMin = latestTimestamp - (recentDays * daysInMillis);

            // Set initial extremes
            currentChart.xAxis[0].setExtremes(initialMin, latestTimestamp);

            console.log('Chart initialized successfully.');
        }

        /**
         * Updates the chart data.
         * @param {Array} data - The updated OHLC data array.
         */
        function updateChartData(data) {
            if (currentChart) {
                const mainSeries = currentChart.get('main-series');
                mainSeries.setData(data, true);
                console.log('Chart data updated.');
            }
        }

        /**
         * Adds an indicator to the chart based on the provided render instructions.
         * @param {Object} render - The render instructions object.
         */
        function addIndicator(render) {
            if (!currentChart || !originalData.length) {
                console.error("Chart is not initialized.");
                return;
            }

            try {
                const { type, color, options } = render;

                // Define a unique name for the indicator based on the type and timestamp
                const seriesName = `${type} - ${new Date().getTime()}`;

                // Prepare the series options
                const seriesOptions = {
                    name: seriesName,
                    data: extractIndicatorData(type),
                    type: type,
                    yAxis: 0,
                    color: color || '#FFFFFF', // Default to white if color not specified
                    tooltip: {
                        valueDecimals: 2
                    },
                    ...options // Spread any additional options
                };

                // Handle different render types
                if (type.toLowerCase() === 'band') {
                    // For shaded regions like Bollinger Bands
                    // Assuming data has two series: upper and lower bands
                    const upperBandData = extractIndicatorData(`${type} Upper Band`);
                    const lowerBandData = extractIndicatorData(`${type} Lower Band`);

                    // Add upper band
                    currentChart.addSeries({
                        name: `${seriesName} Upper Band`,
                        data: upperBandData,
                        type: 'line',
                        yAxis: 0,
                        color: color || '#FFD700',
                        dashStyle: 'Dash',
                        tooltip: {
                            valueDecimals: 2
                        },
                        ...options
                    }, true, true);

                    // Add lower band
                    currentChart.addSeries({
                        name: `${seriesName} Lower Band`,
                        data: lowerBandData,
                        type: 'line',
                        yAxis: 0,
                        color: color || '#FF6347',
                        dashStyle: 'Dash',
                        tooltip: {
                            valueDecimals: 2
                        },
                        ...options
                    }, true, true);

                    // Add a shaded region between upper and lower bands
                    currentChart.addSeries({
                        name: `${seriesName} Shaded Area`,
                        data: createShadedAreaData(upperBandData, lowerBandData),
                        type: 'arearange',
                        yAxis: 0,
                        color: color || 'rgba(173, 216, 230, 0.2)',
                        lineWidth: 0,
                        linkedTo: `${seriesName} Upper Band`,
                        fillOpacity: 0.2,
                        tooltip: {
                            valueDecimals: 2
                        },
                        ...options
                    }, true, true);

                } else {
                    // For line indicators like EMA, SMA, MACD, etc.
                    currentChart.addSeries(seriesOptions, true, true);
                }

                console.log(`Indicator "${seriesName}" added successfully.`);
            } catch (e) {
                console.error("Error adding indicator:", e);
                // Optionally, notify the user about the error
            }
        }

        /**
         * Extracts indicator data from the chart's existing series based on the type.
         * Assumes that the data for indicators are appended to the original data.
         * @param {string} indicatorType - The type/name of the indicator series.
         * @returns {Array} - The data array for the indicator.
         */
        function extractIndicatorData(indicatorType) {
            const series = currentChart.series.find(s => s.name.startsWith(indicatorType));
            if (series) {
                return series.options.data;
            } else {
                console.warn(`No series found for indicator type "${indicatorType}".`);
                return [];
            }
        }

        /**
         * Creates shaded area data between two series.
         * @param {Array} upperBand - Data array for the upper band.
         * @param {Array} lowerBand - Data array for the lower band.
         * @returns {Array} - Data array for the shaded area.
         */
        function createShadedAreaData(upperBand, lowerBand) {
            const shadedData = upperBand.map((point, index) => {
                const lowerPoint = lowerBand[index] || [point[0], null];
                return [point[0], point[1], lowerPoint[1]];
            });
            return shadedData;
        }

        /**
         * Listen for messages from the parent Wix site and update the chart.
         */
        window.addEventListener('message', function(event) {
            // Security: Verify the message origin if needed

            console.log('Received message in chart.html:', event.data);
            if (event.data.type === 'initChart') {
                const { data } = event.data;
                initializeChart(data);
            } else if (event.data.type === 'updateData') {
                const { data } = event.data;
                updateChartData(data);
            } else if (event.data.type === 'addIndicator') {
                const { render } = event.data;
                if (render) {
                    addIndicator(render);
                } else {
                    console.warn("Render instructions missing for addIndicator.");
                }
            }
            // Add more message types and handlers as needed
        }, false);

        /**
         * Notify the parent that the chart is ready (optional)
         */
        window.parent.postMessage({ type: 'chartReady' }, '*'); // Update target origin as needed
    </script>
</body>
</html>
